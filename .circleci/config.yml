version: 2.1
# This code is licensed from CircleCI to the user under the MIT license. See
# https://circleci.com/orbs/registry/licensing for details.
commands:
  dark_deploy:
    parameters:
      appname:
        description: App Name
        type: string
      dark_subdomain:
        default: dark
        description: Cloud Foundry dark domain to prefix domain (i.e. <dark_subdomain>.<domain>,
          defaults to "dark")
        type: string
      domain:
        description: Cloud Foundry domain registered to handle routes for this space
          (a "dark" or "live" sub-domain will be used in conjunction with this, i.e.
          <dark_subdomain>.<domain>)
        type: string
      manifest:
        default: ""
        description: The Cloud Foundry manifest for this environment
        type: string
      package:
        description: path to the asset/package to push
        type: string
      vars:
        default: ""
        description: Vars file for variable substitution.
        type: string
    steps:
      - run:
          command: |
            cf push --no-start "<<parameters.appname>>-dark" -f "<<parameters.manifest>>"<<# parameters.vars>> --vars-file "<<parameters.vars>>"<</ parameters.vars>> -p "<<parameters.package>>"<<# parameters.dark_subdomain>> -n "<<parameters.dark_subdomain>>"<</ parameters.dark_subdomain>> -d "<<parameters.domain>>"
            cf set-env "<<parameters.appname>>-dark" CIRCLE_BUILD_NUM "${CIRCLE_BUILD_NUM}"
            cf set-env "<<parameters.appname>>-dark" CIRCLE_SHA1 "${CIRCLE_SHA1}"
            cf set-env "<<parameters.appname>>-dark" CIRCLE_WORKFLOW_ID "${CIRCLE_WORKFLOW_ID}"
            cf set-env "<<parameters.appname>>-dark" CIRCLE_PROJECT_USERNAME "${CIRCLE_PROJECT_USERNAME}"
            cf set-env "<<parameters.appname>>-dark" CIRCLE_PROJECT_REPONAME "${CIRCLE_PROJECT_REPONAME}"
            cf set-env "<<parameters.appname>>-dark" AWS_ACCESS_KEY_ID "${SFC_CIRCLE_AWS_ACCESS_KEY_ID}"
            cf set-env "<<parameters.appname>>-dark" AWS_SECRET_ACCESS_KEY "${SFC_CIRCLE_AWS_SECRET_ACCESS_KEY}"
            cf set-env "<<parameters.appname>>-dark" NODE_ENV "test"
            # Push as "dark" instance (URL in manifest)
            cf start "<<parameters.appname>>-dark"
            # Ensure dark route is exclusive to dark app
            cf unmap-route "<<parameters.appname>>" "<<parameters.domain>>"<<# parameters.dark_subdomain>> -n "<<parameters.dark_subdomain>>"<</ parameters.dark_subdomain>> || echo "Already exclusive"
          name: Cloud Foundry Dark Deployment
  install:
    description: Installs and authenticates with the latest CLI version if not present.
    parameters:
      endpoint:
        default: https://api.run.pivotal.io
        description: The domain of the Cloud Foundry runtime API endpoint. Defaults
          to https://api.run.pivotal.io
        type: string
      org:
        description: Cloud Foundry org to target
        type: string
      space:
        description: Cloud Foundry space to target
        type: string
    steps:
      - run:
          command: |
            : "${CF_USERNAME?Cloud Foundry username and password must be set as Environment variables before running this command.}"
            : "${CF_PASSWORD?Cloud Foundry username and password must be set as Environment variables before running this command.}"
            curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
            sudo dpkg -i cf-cli_amd64.deb
            cf -v
            cf api "<<parameters.endpoint>>"
            cf auth "$CF_USERNAME" "$CF_PASSWORD"
            cf target -o "<<parameters.org>>" -s "<<parameters.space>>"
          name: Setup CF CLI
  live_deploy:
    parameters:
      appname:
        description: App Name
        type: string
      domain:
        description: Cloud Foundry domain (a "dark" sub-domain will be used on this.)
        type: string
      live_subdomain:
        default: www
        description: Cloud Foundry live subdomain to prefix domain (i.e. <live_subdomain>.<domain>,
          defaults to "wwww")
        type: string
    steps:
      - run:
          command: |
            # Send "real" url to new version
            cf map-route "<<parameters.appname>>-dark" "<<parameters.domain>>"<<# parameters.live_subdomain>> -n "<<parameters.live_subdomain>>"<</ parameters.live_subdomain>>
            # Stop sending traffic to previous version
            cf unmap-route "<<parameters.appname>>" "<<parameters.domain>>"<<# parameters.live_subdomain>> -n "<<parameters.live_subdomain>>"<</ parameters.live_subdomain>>
            # stop previous version
            cf stop "<<parameters.appname>>"
            # delete previous version
            cf delete "<<parameters.appname>>" -f
            # Switch name of "dark" version to claim correct name
            cf rename "<<parameters.appname>>-dark" "<<parameters.appname>>"
          name: Cloud Foundry - Re-route live Domain
  push:
    parameters:
      appname:
        description: App Name
        type: string
      manifest:
        default: ""
        description: The Cloud Foundry manifest for this environment
        type: string
      package:
        default: ""
        description: path to the asset/package to push
        type: string
      vars:
        default: ""
        description: Vars file for variable substitution.
        type: string
    steps:
      - run:
          command: |
            #push no start so we can set envars
            cf push --no-start "<<parameters.appname>>" -f "<<parameters.manifest>>" <<# parameters.vars>> --vars-file "<<parameters.vars>>" <</ parameters.vars>> <<# parameters.package>> -p "<<parameters.package>>" <</ parameters.package>>
            cf set-env "<<parameters.appname>>" CIRCLE_BUILD_NUM "${CIRCLE_BUILD_NUM}"
            cf set-env "<<parameters.appname>>" CIRCLE_SHA1 "${CIRCLE_SHA1}"
            cf set-env "<<parameters.appname>>" CIRCLE_WORKFLOW_ID "${CIRCLE_WORKFLOW_ID}"
            cf set-env "<<parameters.appname>>" CIRCLE_PROJECT_USERNAME "${CIRCLE_PROJECT_USERNAME}"
            cf set-env "<<parameters.appname>>" CIRCLE_PROJECT_REPONAME "${CIRCLE_PROJECT_REPONAME}"
            cf set-env <<parameters.appname>> AWS_ACCESS_KEY_ID "${SFC_CIRCLE_AWS_ACCESS_KEY_ID}"
            cf set-env <<parameters.appname>> AWS_SECRET_ACCESS_KEY "${SFC_CIRCLE_AWS_SECRET_ACCESS_KEY}"
            #now start
            cf start "<<parameters.appname>>"
          name: Cloud Foundry Push

orbs:
  node: circleci/node@1.1.6

workspace_path: &workspace_path
  /home/circleci

use_workspace: &use_workspace
 attach_workspace:
   at: *workspace_path

jobs:
  build:
    executor:
      name: node/default
    steps:
      - checkout
      - node/with-cache:
          steps:
            - run: npm install
  test_frontend:
    executor:
      name: node/default
    steps:
      - checkout
      - run:
          name: Install Headless Chrome dependencies
          command: |
            sudo apt-get install -yq \
            gconf-service libasound2 libatk1.0-0 libatk-bridge2.0-0 libc6 libcairo2 libcups2 libdbus-1-3 \
            libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 \
            libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \
            libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates \
            fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
      - run: npm test
  test_backend:
    executor:
      name: node/default
    steps:
      - checkout
      - run: npm run server:test:unit
  blue_green:
    description: Execute a blue/green deploy  in a single job. Expects either build_steps
      or workspace_path for assets to deploy.
    docker:
      - image: circleci/node:10
    parameters:
      appname:
        description: App Name
        type: string
      build_steps:
        default: []
        description: Steps to generate application package or files. Alternately provide
          `workspace_path`
        type: steps
      dark_subdomain:
        default: dark
        description: Cloud Foundry dark domain to prefix domain (i.e. <dark_subdomain>.<domain>,
          defaults to "dark")
        type: string
      domain:
        description: Cloud Foundry domain registered to handle routes for this space
          (a "dark" or "live" sub-domain will be used in conjunction with this, i.e.
          <dark_subdomain>.<domain>)
        type: string
      endpoint:
        default: https://api.run.pivotal.io
        description: The domain of the Cloud Foundry runtime API endpoint. Defaults
          to https://api.run.pivotal.io
        type: string
      live_subdomain:
        default: www
        description: Cloud Foundry live subdomain to prefix domain (i.e. <live_subdomain>.<domain>,
          defaults to "www")
        type: string
      manifest:
        default: ""
        description: The Cloud Foundry manifest for this environment
        type: string
      org:
        description: Cloud Foundry Org to target
        type: string
      package:
        description: path to the asset/package to push
        type: string
      space:
        description: Cloud Foundry space to target
        type: string
      validate_steps:
        default: []
        description: Optional steps to run between the dark and live deployments.
        type: steps
      vars:
        default: ""
        description: Vars file for variable substitution.
        type: string
      workspace_path:
        default: ""
        description: The key of a workflow workspace which contains artifact. Alternately
          provide `build_steps`
        type: string
    steps:
      - checkout
      - when:
          condition: <<parameters.build_steps>>
          steps: << parameters.build_steps >>
      - when:
          condition: <<parameters.workspace_path>>
          steps:
            - attach_workspace:
                at: <<parameters.workspace_path>>
      - install:
          endpoint: <<parameters.endpoint>>
          org: <<parameters.org>>
          space: <<parameters.space>>
      - dark_deploy:
          appname: <<parameters.appname>>
          dark_subdomain: <<parameters.dark_subdomain>>
          domain: <<parameters.domain>>
          manifest: <<parameters.manifest>>
          package: <<parameters.package>>
          vars: <<parameters.vars>>
      - when:
          condition: <<parameters.validate_steps>>
          steps: << parameters.validate_steps >>
      - live_deploy:
          appname: <<parameters.appname>>
          domain: <<parameters.domain>>
          live_subdomain: <<parameters.live_subdomain>>
workflows:
    build-test-deploy:
      jobs:
        - build
        - test_backend:
            requires:
              - build
        - test_frontend:
            requires:
              - build
        - blue_green:
            appname: sfccircle
            requires:
                - test_frontend
                - test_backend
            endpoint: https://api.cloud.service.gov.uk
            org: dhsc-skills-for-care-nmds-sc-2
            space: sandbox
            manifest: manifest.circle.yml
            package: '.'
            dark_subdomain: sfccircle-dark
            live_subdomain: sfccircle-live
            domain: cloudapps.digital
            build_steps:
                - run: npm install
                - run: npm run build


